<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Admin | Huellitas Villa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
  body {
    background: linear-gradient(to right, #e0f7fa, #ffffff);
    font-family: 'Segoe UI', sans-serif;
    padding-top: 70px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .navbar-brand img {
    height: 40px;
    width: 40px;
    object-fit: cover;
    border-radius: 50%;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    margin-right: 10px;
    transition: transform 0.2s ease-in-out;
  }

  .navbar-brand img:hover {
    transform: scale(1.1);
  }

  .card {
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
    border: none;
  }

  h3, h5 {
    font-weight: bold;
  }

  .btn-danger, .btn-primary, .btn-success, .btn-warning, .btn-outline-primary, .btn-outline-danger {
    border-radius: 10px;
  }

  .table th, .table td {
    vertical-align: middle;
  }

  .table thead th {
    font-weight: 600;
  }

  footer {
    background-color: #000;
    color: #fff;
    text-align: center;
    padding: 20px;
    margin-top: auto;
  }

  .btn-cerrar {
    position: absolute;
    right: 20px;
    top: 12px;
  }
</style>

</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">


  <div class="container position-relative">
    <a class="navbar-brand d-flex align-items-center" href="index.html">
      <img src="huellitas.avif" alt="Huellitas Logo">
      <span>Huellitas Villa | Admin</span>
    </a>
<button onclick="cerrarSesion()" class="btn btn-danger ms-3">Cerrar Sesión</button>

  </div>
</nav>

<!-- CONTENIDO -->
<main class="container my-5">
  <div class="card p-4">
    <h3 class="text-primary mb-4">Gestión de Animales</h3>
    <form id="formAnimal" class="row g-3 align-items-end">
      <input type="hidden" id="animalId" />
      <div class="col-md-3">
        <label class="form-label">Nombre</label>
        <input type="text" class="form-control" id="nombre" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Especie</label>
        <input type="text" class="form-control" id="especie" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Raza</label>
        <input type="text" class="form-control" id="raza" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Edad</label>
        <input type="number" class="form-control" id="edad" required>
      </div>
      <div class="col-md-1 d-grid">
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div>

  <div class="card p-4">
    <h5 class="mb-3">Listado de animales registrados</h5>
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle">
        <thead class="table-primary">
          <tr>
            <th>Nombre</th>
            <th>Especie</th>
            <th>Raza</th>
            <th>Edad</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaAnimales"></tbody>
      </table>
    </div>
  </div>
<!-- NUEVA SECCIÓN: Gestión de Usuarios -->
<div class="card p-4">
  <h3 class="text-primary mb-4">Gestión de Usuarios Registrados</h3>
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-primary">
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Correo</th>
          <th>Rol</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaUsuarios"></tbody>
    </table>
  </div>
</div>
<!-- NUEVA SECCIÓN: Solicitudes de Adopción -->
<div class="card p-4">
  <h3 class="text-primary mb-4">Solicitudes de Adopción</h3>
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-primary">
        <tr>
          <th>ID</th>
          <th>Animal</th>
          <th>Solicitante</th>
          <th>Fecha</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaAdopciones"></tbody>
    </table>
  </div>
</div>
<!-- NUEVA SECCIÓN: Historial de Adopciones -->
<div class="card p-4 mt-4">
  <h3 class="text-primary mb-4">Historial de Solicitudes</h3>
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-secondary">
        <tr>
          <th>ID</th>
          <th>Animal</th>
          <th>Usuario</th>
          <th>Estado</th>
          <th>Fecha</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody id="tablaHistorial"></tbody>
    </table>
  </div>
</div>


</main>

<footer>
  <div class="container">
    <p class="mb-0">© 2025 Huellitas Villa - Panel de Administración</p>
  </div>
</footer>

<!-- Java Script -->
 
<script>
  const sesion = JSON.parse(localStorage.getItem("usuarioLogueado"));
  const usuarioAdmin = sesion?.usuario;

  if (!sesion || sesion.rol !== "ADMIN") {
    alert("Acceso denegado. Solo los administradores pueden acceder.");
    window.location.href = "usuario.html";
  }

  async function cargarAnimales() {
    const res = await fetch("http://localhost:8080/api/animales/listar");
    const lista = await res.json();
    const tabla = document.getElementById("tablaAnimales");
    tabla.innerHTML = "";
    lista.forEach(a => {
      tabla.innerHTML += `
        <tr>
          <td>${a.nombre}</td>
          <td>${a.especie}</td>
          <td>${a.raza}</td>
          <td>${a.edad}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editar(${a.id}, '${a.nombre}', '${a.especie}', '${a.raza}', ${a.edad})">Editar</button>
            <button class="btn btn-sm btn-outline-danger" onclick="eliminar(${a.id})">Eliminar</button>
          </td>
        </tr>
      `;
    });
  }

  cargarAnimales();
cargarUsuarios();
cargarSolicitudes();
cargarHistorial();

async function cargarUsuarios() {
  const res = await fetch("http://localhost:8080/api/usuarios/listar");
  const usuarios = await res.json();
  const tabla = document.getElementById("tablaUsuarios");
  tabla.innerHTML = "";

  usuarios.forEach(u => {
    tabla.innerHTML += `
      <tr>
        <td>${u.id}</td>
        <td><input class="form-control form-control-sm" value="${u.usuario}" onchange="editarUsuario(${u.id})" id="usuario-${u.id}"></td>
        <td><input class="form-control form-control-sm" value="${u.correo}" onchange="editarUsuario(${u.id})" id="correo-${u.id}"></td>
        <td>
          <select class="form-select form-select-sm" onchange="editarUsuario(${u.id})" id="rol-${u.id}">
            <option ${u.rol === "USER" ? "selected" : ""}>USER</option>
            <option ${u.rol === "ADMIN" ? "selected" : ""}>ADMIN</option>
          </select>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-danger" onclick="eliminarUsuario(${u.id})">Eliminar</button>
        </td>
      </tr>
    `;
  });
}

async function editarUsuario(id) {
  const usuario = document.getElementById(`usuario-${id}`).value;
  const correo = document.getElementById(`correo-${id}`).value;
  const rol = document.getElementById(`rol-${id}`).value;

  const res = await fetch(`http://localhost:8080/api/usuarios/actualizar/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usuario, correo, rol })
  });

  alert(await res.text());
  cargarUsuarios();


}

async function eliminarUsuario(id) {
  if (!confirm("¿Estás seguro de eliminar este usuario?")) return;

  const res = await fetch(`http://localhost:8080/api/usuarios/eliminar/${id}`, {
    method: "DELETE"
  });

  alert(await res.text());
  cargarUsuarios();
}

  document.getElementById("formAnimal").addEventListener("submit", async e => {
    e.preventDefault();
    const id = document.getElementById("animalId").value;
    const animal = {
      nombre: document.getElementById("nombre").value,
      especie: document.getElementById("especie").value,
      raza: document.getElementById("raza").value,
      edad: parseInt(document.getElementById("edad").value)
    };

    const url = id
      ? `http://localhost:8080/api/animales/actualizar/${id}?usuario=${usuarioAdmin}`
      : `http://localhost:8080/api/animales/agregar?usuario=${usuarioAdmin}`;

    const method = id ? "PUT" : "POST";

    const res = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(animal)
    });

    alert(await res.text());
    document.getElementById("formAnimal").reset();
    document.getElementById("animalId").value = "";
    cargarAnimales();
  });

  function editar(id, nombre, especie, raza, edad) {
    document.getElementById("animalId").value = id;
    document.getElementById("nombre").value = nombre;
    document.getElementById("especie").value = especie;
    document.getElementById("raza").value = raza;
    document.getElementById("edad").value = edad;
  }

  async function eliminar(id) {
    if (!confirm("¿Estás seguro de eliminar este animal?")) return;
    const res = await fetch(`http://localhost:8080/api/animales/eliminar/${id}?usuario=${usuarioAdmin}`, {
      method: "DELETE"
    });
    alert(await res.text());
    cargarAnimales();
  }

  function cerrarSesion() {
    localStorage.removeItem("usuarioLogueado");
    alert("Sesión cerrada.");
    window.location.href = "usuario.html";
  }
async function cargarSolicitudes() {
  const res = await fetch("http://localhost:8080/api/adopciones/pendientes");
  const lista = await res.json();
  const tabla = document.getElementById("tablaAdopciones");
  tabla.innerHTML = "";

  lista.forEach(s => {
    let acciones = "";

    if (s.estado === "pendiente") {
      acciones = `
        <button class="btn btn-sm btn-success me-1" onclick="gestionarSolicitud('${s.usuario}', '${s.nombre_animal}', 'aprobada')">Aceptar</button>
        <button class="btn btn-sm btn-danger me-1" onclick="gestionarSolicitud('${s.usuario}', '${s.nombre_animal}', 'rechazada')">Rechazar</button>
      `;
    } else if (s.estado === "aprobada") {
      acciones = `
        <button class="btn btn-sm btn-outline-warning" onclick="gestionarSolicitud('${s.usuario}', '${s.nombre_animal}', 'devuelto')">Marcar como devuelto</button>
      `;
    } else {
      acciones = `<span class="text-muted">No disponible</span>`;
    }

    tabla.innerHTML += `
      <tr>
        <td>${s.id}</td>
        <td>${s.nombre_animal}</td>
        <td>${s.usuario}</td>
        <td>${new Date(s.fecha).toLocaleString()}</td>
        <td>${s.estado}</td>
        <td>${acciones}</td>
      </tr>
    `;
  });
}
async function cargarHistorial() {
  const res = await fetch("http://localhost:8080/api/adopciones/todas");
  const lista = await res.json();
  const tabla = document.getElementById("tablaHistorial");
  tabla.innerHTML = "";

  lista
    .filter(s => s.estado !== "pendiente" && s.estado !== "devuelto")
    .forEach(s => {
      tabla.innerHTML += `
        <tr>
          <td>${s.id}</td>
          <td>${s.nombre_animal}</td>
          <td>${s.usuario}</td>
          <td>${s.estado}</td>
          <td>${s.fecha}</td>
          <td>
            ${s.estado === "aprobada"
              ? `<button class="btn btn-warning btn-sm" onclick="gestionarSolicitud('${s.usuario}', '${s.nombre_animal}', 'devuelto')">Devolver</button>`
              : "-"}
          </td>
        </tr>
      `;
    });
}


async function gestionarSolicitud(usuario, nombreAnimal, estado) {
  if (!confirm(`¿Deseas ${estado === 'aprobada' ? 'aprobar' : 'rechazar'} esta solicitud?`)) return;

  const res = await fetch("http://localhost:8080/api/adopciones/actualizar-estado", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usuario, nombre_animal: nombreAnimal, estado })
  });

  const msg = await res.text();
  alert(msg);
  cargarSolicitudes();
}

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
